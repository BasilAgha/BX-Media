<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BX Media - Client Projects</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/dashboard.css" />
</head>

<body>
<div class="shell shell-multi">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">
      <img src="../assets/index/7 logo.png" alt="BX Media" />
      <span>BX Media</span>
    </div>

    <div class="sidebar-section-title">Navigation</div>
    <nav class="nav">
      <a href="client-dashboard-overview.html" id="navOverview">Overview</a>
      <a href="client-dashboard-projects.html" id="navProjectsLink">Projects</a>
      <a href="client-dashboard-tasks.html" id="navTasksLink">Tasks</a>
      <button id="logoutBtn">Log out</button>
    </nav>

    <div class="sidebar-section-title stats-title">Overview</div>
    <div class="sidebar-stats-grid">
      <div class="stat-card"><span>Total projects</span><strong id="statTotalProjects">0</strong></div>
      <div class="stat-card"><span>Total tasks</span><strong id="statTotalTasks">0</strong></div>
      <div class="stat-card"><span>In progress</span><strong id="statInProgress">0</strong></div>
      <div class="stat-card"><span>Completed</span><strong id="statCompleted">0</strong></div>
      <div class="stat-card"><span>Not started</span><strong id="statNotStarted">0</strong></div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="content">
    <section class="panel">

      <header class="panel-header">
        <div>
          <h1>Your Projects</h1>
        </div>
      </header>

      <section class="subpanel">
        <h2>Projects</h2>
        <div id="projectsList"></div>
      </section>

    </section>
  </main>

</div>

<script src="js/dashboard-core.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const sess = BXCore.requireAuth();
  if (!sess) return;

  const projectsList = document.getElementById("projectsList");
  BXCore.renderSkeleton(projectsList, "card", 3);

  let data;
  try {
    data = await BXCore.apiGetAll();
    BXCore.updateSidebarStats(data);
  } catch (err) {
    console.error(err);
    projectsList.innerHTML =
      '<div class="empty">We could not load projects. Please refresh and try again.</div>';
    return;
  }

  let clientId = sess.clientId;
  if (!clientId && sess.username) {
    const match = (data.clients || []).find((c) => c.username === sess.username);
    clientId = match ? match.clientId : null;
  }

  const projects = (data.projects || []).filter((p) => p.clientId === clientId);
  const tasks = data.tasks || [];

  projectsList.innerHTML = "";

  if (!projects.length) {
    projectsList.innerHTML = '<div class="empty">No projects yet.</div>';
    return;
  }

  projects.forEach((p) => {
    const taskList = tasks.filter((t) => t.projectId === p.projectId);
    const progress = BXCore.computeProjectProgress(taskList);
    const updatedLabel = BXCore.formatDateTime(p.updatedAt || p.createdAt) || "Not updated yet";
    const statusValue = p.status || "in-progress";

    const card = document.createElement("article");
    card.className = "project-card project-card-link";
    card.dataset.href = `client-dashboard-tasks.html?projectId=${encodeURIComponent(p.projectId)}`;
    card.innerHTML = `
      <header>
        <div>
          <h3>${p.name}</h3>
          <p class="project-desc">${p.description || ""}</p>
          <p class="project-meta-line">Updated: ${updatedLabel}</p>
        </div>
        <span class="badge ${statusValue}">Status: ${statusValue.replace("-", " ")}</span>
      </header>

      <div class="project-meta">
        <div style="flex:1">
          <progress max="100" value="${progress}"></progress>
        </div>
        <span class="progress-label">${progress}%</span>
        ${p.driveLink ? `<a class="ghost" href="${p.driveLink}" target="_blank" rel="noopener">Drive</a>` : ""}
      </div>

      <div class="project-desc" style="font-size:0.8rem;margin-top:0.3rem;">
        ${taskList.length} tasks
      </div>
    `;
    projectsList.appendChild(card);
  });

  projectsList.addEventListener("click", (e) => {
    const card = e.target.closest(".project-card-link");
    if (!card) return;
    if (e.target.closest("a")) return;
    BXCore.showPageLoader("Loading project tasks...");
    window.location.href = card.dataset.href;
  });
});
</script>

</body>
</html>
